
> ourtextscores-root-tools@0.0.0 smoke
> npm run smoke:up && npm run smoke:install && npm run smoke:run && npm run smoke:down


> ourtextscores-root-tools@0.0.0 smoke:up
> docker compose build backend frontend && docker compose up -d && node smoke/utils/wait.cjs

#1 [internal] load local bake definitions
#1 reading from stdin 1.12kB done
#1 DONE 0.0s

#2 [backend internal] load build definition from Dockerfile
#2 transferring dockerfile: 1.18kB done
#2 DONE 0.1s

#3 [frontend internal] load build definition from Dockerfile
#3 transferring dockerfile: 774B done
#3 DONE 0.1s

#4 [frontend] resolve image config for docker-image://docker.io/docker/dockerfile:1
#4 DONE 0.3s

#5 [frontend] docker-image://docker.io/docker/dockerfile:1@sha256:b6afd42430b15f2d2a4c5a02b919e98a525b785b1aaff16747d2f623364e39b6
#5 CACHED

#6 [backend internal] load metadata for docker.io/library/ubuntu:22.04
#6 ...

#7 [frontend internal] load metadata for docker.io/library/node:20-alpine
#7 DONE 0.2s

#6 [backend internal] load metadata for docker.io/library/ubuntu:22.04
#6 DONE 0.2s

#8 [frontend internal] load .dockerignore
#8 transferring context: 2B done
#8 DONE 0.1s

#9 [backend internal] load .dockerignore
#9 transferring context: 2B done
#9 DONE 0.1s

#10 [frontend deps 1/4] FROM docker.io/library/node:20-alpine@sha256:6178e78b972f79c335df281f4b7674a2d85071aae2af020ffa39f0a770265435
#10 DONE 0.0s

#11 [frontend internal] load build context
#11 ...

#12 [backend base 1/3] FROM docker.io/library/ubuntu:22.04@sha256:09506232a8004baa32c47d68f1e5c307d648fdd59f5e7eaa42aaf87914100db3
#12 DONE 0.0s

#11 [frontend internal] load build context
#11 ...

#13 [backend internal] load build context
#13 transferring context: 2.22MB 4.0s done
#13 DONE 4.1s

#14 [backend build 3/3] RUN npm run build
#14 CACHED

#15 [backend runner 2/4] COPY --from=build /app/dist ./dist
#15 CACHED

#16 [backend runner 1/4] COPY --from=build /app/node_modules ./node_modules
#16 CACHED

#17 [backend runner 3/4] COPY --from=build /app/package*.json ./
#17 CACHED

#18 [backend base 3/3] RUN apt-get update &&     apt-get install -y curl gnupg &&     curl -fsSL https://deb.nodesource.com/setup_20.x | bash - &&     apt-get install -y --no-install-recommends         nodejs         python3         python3-pip         unzip         git         musescore3         fossil &&     pip3 install --no-cache-dir         linearized-musicxml         musicdiff         imslp         PyPDF2 &&     apt-get clean && rm -rf /var/lib/apt/lists/*
#18 CACHED

#19 [backend deps 1/2] COPY package*.json ./
#19 CACHED

#20 [backend deps 2/2] RUN if [ -f package-lock.json ]; then npm ci; else npm install; fi
#20 CACHED

#21 [backend base 2/3] WORKDIR /app
#21 CACHED

#22 [backend build 1/3] COPY --from=deps /app/node_modules ./node_modules
#22 CACHED

#23 [backend build 2/3] COPY . .
#23 CACHED

#24 [backend runner 4/4] COPY --from=build /app/python ./python
#24 CACHED

#25 [backend] exporting to image
#25 exporting layers done
#25 writing image sha256:a9aed7252e5a6fdd5558a89f119d92e554c3496eecf21112bc6f6888b70e6a86 done
#25 naming to docker.io/library/ourtextscores-backend 0.0s done
#25 DONE 0.0s

#26 [backend] resolving provenance for metadata file
#26 DONE 0.1s

#11 [frontend internal] load build context
#11 transferring context: 2.45MB 4.8s done
#11 DONE 4.9s

#27 [frontend builder 5/5] RUN npm run build
#27 CACHED

#28 [frontend deps 3/4] COPY package*.json ./
#28 CACHED

#29 [frontend runner 3/6] COPY --from=builder /app/public ./public
#29 CACHED

#30 [frontend deps 2/4] WORKDIR /app
#30 CACHED

#31 [frontend deps 4/4] RUN npm install
#31 CACHED

#32 [frontend builder 3/5] COPY --from=deps /app/node_modules ./node_modules
#32 CACHED

#33 [frontend builder 4/5] COPY . .
#33 CACHED

#34 [frontend runner 4/6] COPY --from=builder /app/.next ./.next
#34 CACHED

#35 [frontend runner 5/6] COPY --from=builder /app/package*.json ./
#35 CACHED

#36 [frontend runner 6/6] COPY --from=builder /app/node_modules ./node_modules
#36 CACHED

#37 [frontend] exporting to image
#37 exporting layers done
#37 writing image sha256:ee6d0c7d35a737c119814212faf6c844710a0b5cc700102bc53b509f404067d1 done
#37 naming to docker.io/library/ourtextscores-frontend done
#37 DONE 0.0s

#38 [frontend] resolving provenance for metadata file
#38 DONE 0.0s
 ourtextscores-backend  Built
 ourtextscores-frontend  Built
 Container ourtextscores_minio  Running
 Container ourtextscores_mailpit  Running
 Container ourtextscores_meili  Running
 Container ourtextscores_mongo  Running
 Container ourtextscores_backend  Running
 Container ourtextscores_frontend  Running
Waiting for http://localhost:3000 ...
Waiting for http://localhost:3000/api/diagnostics/email ...
Waiting for http://localhost:4000/api/works ...
All services are healthy.

> ourtextscores-root-tools@0.0.0 smoke:install
> npx playwright install chromium

BEWARE: your OS is not officially supported by Playwright; downloading fallback build for ubuntu24.04-x64.
BEWARE: your OS is not officially supported by Playwright; downloading fallback build for ubuntu24.04-x64.

> ourtextscores-root-tools@0.0.0 smoke:run
> npx playwright test -c smoke/playwright.config.cjs --project=chromium


Running 6 tests using 1 worker

  âœ“  1 [chromium] â€º auth-email.spec.cjs:47:3 â€º Email auth (magic link) â€º sign in via email and see session UI (2.4s)
  âœ˜  2 [chromium] â€º branch-approvals.spec.cjs:47:3 â€º Owned branch + approvals flow â€º create owned branch, upload to it, approve, and see filter option (1.2m)
  âœ“  3 [chromium] â€º public-links.spec.cjs:7:3 â€º Public links + health â€º health endpoints are OK (1.1s)
  âœ˜  4 [chromium] â€º public-links.spec.cjs:14:3 â€º Public links + health â€º work detail anchors use public API base and resolve (3.4m)
  âœ“  5 [chromium] â€º sse-progress.spec.cjs:8:3 â€º SSE progress sanity â€º receives progress events during upload and completes (4.5s)
  âœ“  6 [chromium] â€º viewers-diff-watch.spec.cjs:47:3 â€º Viewers + Diff + Watch â€º renders OSMD/PDF and diff, and toggles watch (47.9s)


  1) [chromium] â€º branch-approvals.spec.cjs:47:3 â€º Owned branch + approvals flow â€º create owned branch, upload to it, approve, and see filter option 

    [31mTest timeout of 60000ms exceeded.[39m

    Error: Object with guid response@24ec1d9e6f3d487e4cccb0443d434e56 was not bound in the connection

    attachment #1: trace (application/zip) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    test-results/branch-approvals-Owned-bra-69239-prove-and-see-filter-option-chromium/trace.zip
    Usage:

        npx playwright show-trace test-results/branch-approvals-Owned-bra-69239-prove-and-see-filter-option-chromium/trace.zip

    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  2) [chromium] â€º public-links.spec.cjs:14:3 â€º Public links + health â€º work detail anchors use public API base and resolve 

    [31mTest timeout of 60000ms exceeded.[39m

    Error: apiRequestContext.get: Target page, context or browser has been closed
    Call log:
      [2m- â†’ GET http://localhost:4000/api/works/164349/sources/b83ce04c-3428-4ef2-800c-0fa25bf14ba6/score.pdf?r=7e348d05-6bdf-4652-ba93-750b963959fd[22m
    [2m  -   user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.6723.31 Safari/537.36[22m
    [2m  -   accept: */*[22m
    [2m  -   accept-encoding: gzip,deflate,br[22m


      31 |       if (!href) continue;
      32 |       expect(href.startsWith(`${PUBLIC_API}/`)).toBeTruthy();
    > 33 |       const resp = await request.get(href);
         |                                  ^
      34 |       if (resp.status() === 200) okCount += 1;
      35 |     }
      36 |     expect(okCount).toBeGreaterThan(0);

        at /home/jhlusko/workspace/OurTextScores/smoke/e2e/public-links.spec.cjs:33:34

    attachment #1: trace (application/zip) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    test-results/public-links-Public-links--dadfe-public-API-base-and-resolve-chromium/trace.zip
    Usage:

        npx playwright show-trace test-results/public-links-Public-links--dadfe-public-API-base-and-resolve-chromium/trace.zip

    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Slow test file: [chromium] â€º public-links.spec.cjs (3.4m)
  Slow test file: [chromium] â€º branch-approvals.spec.cjs (1.2m)
  Slow test file: [chromium] â€º viewers-diff-watch.spec.cjs (47.9s)
  Consider splitting slow test files to speed up parallel execution
  2 failed
    [chromium] â€º branch-approvals.spec.cjs:47:3 â€º Owned branch + approvals flow â€º create owned branch, upload to it, approve, and see filter option 
    [chromium] â€º public-links.spec.cjs:14:3 â€º Public links + health â€º work detail anchors use public API base and resolve 
  4 passed (9.1m)
